---
title: å¤šçº§ç¼“å­˜
date: 2022-12-13
---

## ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜

ä¼ ç»Ÿçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚å›¾ï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131212.png" alt="image-20210821075259137" style="zoom:67%;" />

**å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š**

â€¢è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ

â€¢Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡»

**å¤šçº§ç¼“å­˜å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½»Tomcatå‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼š**

- æµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜
- è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯
- è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜
- å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰
- å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcat
- è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜
- å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131215.png" alt="image-20210821075558137" style="zoom:67%;" />

åœ¨å¤šçº§ç¼“å­˜æ¶æ„ä¸­ï¼ŒNginxå†…éƒ¨éœ€è¦ç¼–å†™æœ¬åœ°ç¼“å­˜æŸ¥è¯¢ã€RedisæŸ¥è¯¢ã€TomcatæŸ¥è¯¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œå› æ­¤è¿™æ ·çš„nginxæœåŠ¡ä¸å†æ˜¯ä¸€ä¸ª**åå‘ä»£ç†æœåŠ¡å™¨**ï¼Œè€Œæ˜¯ä¸€ä¸ªç¼–å†™**ä¸šåŠ¡çš„WebæœåŠ¡å™¨äº†**ã€‚

å› æ­¤è¿™æ ·çš„ä¸šåŠ¡NginxæœåŠ¡ä¹Ÿéœ€è¦æ­å»ºé›†ç¾¤æ¥æé«˜å¹¶å‘ï¼Œå†æœ‰ä¸“é—¨çš„nginxæœåŠ¡æ¥åšåå‘ä»£ç†ï¼Œå¦‚å›¾ï¼š

![image-20210821080511581](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131214.png)

å¦å¤–ï¼Œæˆ‘ä»¬çš„TomcatæœåŠ¡å°†æ¥ä¹Ÿä¼šéƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼š

![image-20210821080954947](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131217.png)

å¯è§ï¼Œå¤šçº§ç¼“å­˜çš„å…³é”®æœ‰ä¸¤ä¸ªï¼š

- ä¸€ä¸ªæ˜¯åœ¨nginxä¸­ç¼–å†™ä¸šåŠ¡ï¼Œå®ç°nginxæœ¬åœ°ç¼“å­˜ã€Redisã€Tomcatçš„æŸ¥è¯¢

- å¦ä¸€ä¸ªå°±æ˜¯åœ¨Tomcatä¸­å®ç°JVMè¿›ç¨‹ç¼“å­˜

å…¶ä¸­Nginxç¼–ç¨‹åˆ™ä¼šç”¨åˆ°OpenRestyæ¡†æ¶ç»“åˆLuaè¿™æ ·çš„è¯­è¨€ã€‚

## JVMè¿›ç¨‹ç¼“å­˜

### åˆè¯†Caffeine

ç¼“å­˜åœ¨æ—¥å¸¸å¼€å‘ä¸­å¯åŠ¨è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œç”±äºæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®çš„è¯»å–é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œèƒ½å¤§é‡å‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚æˆ‘ä»¬æŠŠç¼“å­˜åˆ†ä¸ºä¸¤ç±»ï¼š

- åˆ†å¸ƒå¼ç¼“å­˜ï¼Œä¾‹å¦‚Redisï¼š
  - ä¼˜ç‚¹ï¼šå­˜å‚¨å®¹é‡æ›´å¤§ã€å¯é æ€§æ›´å¥½ã€å¯ä»¥åœ¨é›†ç¾¤é—´å…±äº«
  - ç¼ºç‚¹ï¼šè®¿é—®ç¼“å­˜æœ‰ç½‘ç»œå¼€é”€
  - åœºæ™¯ï¼šç¼“å­˜æ•°æ®é‡è¾ƒå¤§ã€å¯é æ€§è¦æ±‚è¾ƒé«˜ã€éœ€è¦åœ¨é›†ç¾¤é—´å…±äº«
- è¿›ç¨‹æœ¬åœ°ç¼“å­˜ï¼Œä¾‹å¦‚HashMapã€GuavaCacheï¼š
  - ä¼˜ç‚¹ï¼šè¯»å–æœ¬åœ°å†…å­˜ï¼Œæ²¡æœ‰ç½‘ç»œå¼€é”€ï¼Œé€Ÿåº¦æ›´å¿«
  - ç¼ºç‚¹ï¼šå­˜å‚¨å®¹é‡æœ‰é™ã€å¯é æ€§è¾ƒä½ã€æ— æ³•å…±äº«
  - åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œç¼“å­˜æ•°æ®é‡è¾ƒå°

**Caffeine**æ˜¯ä¸€ä¸ªåŸºäºJava8å¼€å‘çš„ï¼Œæä¾›äº†è¿‘ä¹æœ€ä½³å‘½ä¸­ç‡çš„é«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“ã€‚ç›®å‰Springå†…éƒ¨çš„ç¼“å­˜ä½¿ç”¨çš„å°±æ˜¯[Caffeine](https://github.com/ben-manes/caffeine)ã€‚

Caffeineçš„æ€§èƒ½éå¸¸å¥½ï¼Œä¸‹å›¾æ˜¯å®˜æ–¹ç»™å‡ºçš„æ€§èƒ½å¯¹æ¯”ï¼š

![image-20210821081826399](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131234.png)

ç¼“å­˜ä½¿ç”¨çš„åŸºæœ¬APIï¼š

```java
@Test
void testBasicOps() {
    // æ„å»ºcacheå¯¹è±¡
    Cache<String, String> cache = Caffeine.newBuilder().build();

    // å­˜æ•°æ®
    cache.put("gf", "è¿ªä¸½çƒ­å·´");

    // å–æ•°æ®
    String gf = cache.getIfPresent("gf");
    System.out.println("gf = " + gf);

    // å–æ•°æ®ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š
    // å‚æ•°ä¸€ï¼šç¼“å­˜çš„key
    // å‚æ•°äºŒï¼šLambdaè¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼å‚æ•°å°±æ˜¯ç¼“å­˜çš„keyï¼Œæ–¹æ³•ä½“æ˜¯æŸ¥è¯¢æ•°æ®åº“çš„é€»è¾‘
    // ä¼˜å…ˆæ ¹æ®keyæŸ¥è¯¢JVMç¼“å­˜ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œåˆ™æ‰§è¡Œå‚æ•°äºŒçš„Lambdaè¡¨è¾¾å¼
    String defaultGF = cache.get("defaultGF", key -> {
        // æ ¹æ®keyå»æ•°æ®åº“æŸ¥è¯¢æ•°æ®
        return "æŸ³å²©";
    });
    System.out.println("defaultGF = " + defaultGF);
}
```

Caffeineæ—¢ç„¶æ˜¯ç¼“å­˜çš„ä¸€ç§ï¼Œè‚¯å®šéœ€è¦æœ‰ç¼“å­˜çš„æ¸…é™¤ç­–ç•¥ï¼Œä¸ç„¶çš„è¯å†…å­˜æ€»ä¼šæœ‰è€—å°½çš„æ—¶å€™ã€‚

Caffeineæä¾›äº†ä¸‰ç§ç¼“å­˜é©±é€ç­–ç•¥ï¼š

- **åŸºäºå®¹é‡**ï¼šè®¾ç½®ç¼“å­˜çš„æ•°é‡ä¸Šé™

  ```java
  // åˆ›å»ºç¼“å­˜å¯¹è±¡
  Cache<String, String> cache = Caffeine.newBuilder()
      .maximumSize(1) // è®¾ç½®ç¼“å­˜å¤§å°ä¸Šé™ä¸º 1
      .build();
  ```

- **åŸºäºæ—¶é—´**ï¼šè®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´

  ```java
  // åˆ›å»ºç¼“å­˜å¯¹è±¡
  Cache<String, String> cache = Caffeine.newBuilder()
      // è®¾ç½®ç¼“å­˜æœ‰æ•ˆæœŸä¸º 10 ç§’ï¼Œä»æœ€åä¸€æ¬¡å†™å…¥å¼€å§‹è®¡æ—¶ 
      .expireAfterWrite(Duration.ofSeconds(10)) 
      .build();
  
  ```

- **åŸºäºå¼•ç”¨**ï¼šè®¾ç½®ç¼“å­˜ä¸ºè½¯å¼•ç”¨æˆ–å¼±å¼•ç”¨ï¼Œåˆ©ç”¨GCæ¥å›æ”¶ç¼“å­˜æ•°æ®ã€‚æ€§èƒ½è¾ƒå·®ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚

> **æ³¨æ„**ï¼šåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç¼“å­˜å…ƒç´ è¿‡æœŸçš„æ—¶å€™ï¼ŒCaffeineä¸ä¼šè‡ªåŠ¨ç«‹å³å°†å…¶æ¸…ç†å’Œé©±é€ã€‚è€Œæ˜¯åœ¨ä¸€æ¬¡è¯»æˆ–å†™æ“ä½œåï¼Œæˆ–è€…åœ¨ç©ºé—²æ—¶é—´å®Œæˆå¯¹å¤±æ•ˆæ•°æ®çš„é©±é€ã€‚

### å®ç°JVMè¿›ç¨‹ç¼“å­˜

#### éœ€æ±‚

åˆ©ç”¨Caffeineå®ç°ä¸‹åˆ—éœ€æ±‚ï¼š

- ç»™æ ¹æ®idæŸ¥è¯¢å•†å“çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“
- ç»™æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“
- ç¼“å­˜åˆå§‹å¤§å°ä¸º100
- ç¼“å­˜ä¸Šé™ä¸º10000

#### å®ç°

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªCaffeineçš„ç¼“å­˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¿å­˜å•†å“ã€åº“å­˜çš„ç¼“å­˜æ•°æ®ã€‚

åœ¨item-serviceçš„`com.heima.item.config`åŒ…ä¸‹å®šä¹‰`CaffeineConfig`ç±»ï¼š

```java
package com.heima.item.config;

import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import com.heima.item.pojo.Item;
import com.heima.item.pojo.ItemStock;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class CaffeineConfig {

    @Bean
    public Cache<Long, Item> itemCache(){
        return Caffeine.newBuilder()
                .initialCapacity(100)
                .maximumSize(10_000)
                .build();
    }

    @Bean
    public Cache<Long, ItemStock> stockCache(){
        return Caffeine.newBuilder()
                .initialCapacity(100)
                .maximumSize(10_000)
                .build();
    }
}
```

ç„¶åï¼Œä¿®æ”¹item-serviceä¸­çš„`com.heima.item.web`åŒ…ä¸‹çš„ItemControllerç±»ï¼Œæ·»åŠ ç¼“å­˜é€»è¾‘ï¼š

```java
@RestController
@RequestMapping("item")
public class ItemController {

    @Autowired
    private IItemService itemService;
    @Autowired
    private IItemStockService stockService;

    @Autowired
    private Cache<Long, Item> itemCache;
    @Autowired
    private Cache<Long, ItemStock> stockCache;
    
    // ...å…¶å®ƒç•¥
    
    @GetMapping("/{id}")
    public Item findById(@PathVariable("id") Long id) {
        return itemCache.get(id, key -> itemService.query()
                .ne("status", 3).eq("id", key)
                .one()
        );
    }

    @GetMapping("/stock/{id}")
    public ItemStock findStockById(@PathVariable("id") Long id) {
        return stockCache.get(id, key -> stockService.getById(key));
    }
}
```

## Luaè¯­æ³•å…¥é—¨

Nginxç¼–ç¨‹éœ€è¦ç”¨åˆ°Luaè¯­è¨€ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»å…ˆå…¥é—¨Luaçš„åŸºæœ¬è¯­æ³•ã€‚

### åˆè¯†Lua

Lua æ˜¯ä¸€ç§è½»é‡å°å·§çš„è„šæœ¬è¯­è¨€ï¼Œç”¨æ ‡å‡†Cè¯­è¨€ç¼–å†™å¹¶ä»¥æºä»£ç å½¢å¼å¼€æ”¾ï¼Œ å…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åµŒå…¥åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºæä¾›çµæ´»çš„æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ã€‚[Lua å®˜ç½‘](https://www.lua.org/)

Lua ç»å¸¸åµŒå…¥åˆ°Cè¯­è¨€å¼€å‘çš„ç¨‹åºä¸­ï¼Œä¾‹å¦‚æ¸¸æˆå¼€å‘ã€æ¸¸æˆæ’ä»¶ç­‰ã€‚

Nginx æœ¬èº«ä¹Ÿæ˜¯Cè¯­è¨€å¼€å‘ï¼Œå› æ­¤ä¹Ÿå…è®¸åŸºäºLuaåšæ‹“å±•ã€‚

### HelloWorld

CentOS 7é»˜è®¤å·²ç»å®‰è£…äº† Lua è¯­è¨€ç¯å¢ƒï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿è¡Œ Luaä»£ç ã€‚

1ï¼‰åœ¨Linuxè™šæ‹Ÿæœºçš„ä»»æ„ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªhello.luaæ–‡ä»¶

![image-20210821091621308](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131749.png)

2ï¼‰æ·»åŠ ä¸‹é¢çš„å†…å®¹

```lua
print("Hello World!")  
```

3ï¼‰è¿è¡Œ

![image-20210821091638140](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131757.png)

### å˜é‡å’Œå¾ªç¯

#### Luaçš„æ•°æ®ç±»å‹

Luaä¸­æ”¯æŒçš„å¸¸è§æ•°æ®ç±»å‹åŒ…æ‹¬ï¼š

![image-20210821091835406](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131765.png)

å¦å¤–ï¼ŒLuaæä¾›äº†type()å‡½æ•°æ¥åˆ¤æ–­ä¸€ä¸ªå˜é‡çš„æ•°æ®ç±»å‹ï¼š

![image-20210821091904332](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131783.png)

#### å£°æ˜å˜é‡

Luaå£°æ˜å˜é‡çš„æ—¶å€™æ— éœ€æŒ‡å®šæ•°æ®ç±»å‹ï¼Œè€Œæ˜¯ç”¨localæ¥å£°æ˜å˜é‡ä¸ºå±€éƒ¨å˜é‡ï¼š

```lua
-- å£°æ˜å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨å•å¼•å·æˆ–åŒå¼•å·ï¼Œ
local str = 'hello'
-- å­—ç¬¦ä¸²æ‹¼æ¥å¯ä»¥ä½¿ç”¨ ..
local str2 = 'hello' .. 'world'
-- å£°æ˜æ•°å­—
local num = 21
-- å£°æ˜å¸ƒå°”ç±»å‹
local flag = true
```



Luaä¸­çš„tableç±»å‹æ—¢å¯ä»¥ä½œä¸ºæ•°ç»„ï¼Œåˆå¯ä»¥ä½œä¸ºJavaä¸­çš„mapæ¥ä½¿ç”¨ã€‚æ•°ç»„å°±æ˜¯ç‰¹æ®Šçš„tableï¼Œkeyæ˜¯æ•°ç»„è§’æ ‡è€Œå·²ï¼š

```lua
-- å£°æ˜æ•°ç»„ ï¼Œkeyä¸ºè§’æ ‡çš„ table
local arr = {'java', 'python', 'lua'}
-- å£°æ˜tableï¼Œç±»ä¼¼javaçš„map
local map =  {name='Jack', age=21}
```

Luaä¸­çš„æ•°ç»„è§’æ ‡æ˜¯ä»1å¼€å§‹ï¼Œè®¿é—®çš„æ—¶å€™ä¸Javaä¸­ç±»ä¼¼ï¼š

```lua
-- è®¿é—®æ•°ç»„ï¼Œluaæ•°ç»„çš„è§’æ ‡ä»1å¼€å§‹
print(arr[1])
```

Luaä¸­çš„tableå¯ä»¥ç”¨keyæ¥è®¿é—®ï¼š

```lua
-- è®¿é—®table
print(map['name'])
print(map.name)
```

#### å¾ªç¯

å¯¹äºtableï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨forå¾ªç¯æ¥éå†ã€‚ä¸è¿‡æ•°ç»„å’Œæ™®é€štableéå†ç•¥æœ‰å·®å¼‚ã€‚

éå†æ•°ç»„ï¼š

```lua
-- å£°æ˜æ•°ç»„ keyä¸ºç´¢å¼•çš„ table
local arr = {'java', 'python', 'lua'}
-- éå†æ•°ç»„
for index,value in ipairs(arr) do
    print(index, value) 
end
```

éå†æ™®é€štable

```lua
-- å£°æ˜mapï¼Œä¹Ÿå°±æ˜¯table
local map = {name='Jack', age=21}
-- éå†table
for key,value in pairs(map) do
   print(key, value) 
end
```

### æ¡ä»¶æ§åˆ¶ã€å‡½æ•°

Luaä¸­çš„æ¡ä»¶æ§åˆ¶å’Œå‡½æ•°å£°æ˜ä¸Javaç±»ä¼¼ã€‚

#### å‡½æ•°

å®šä¹‰å‡½æ•°çš„è¯­æ³•ï¼š

```lua
function å‡½æ•°å( argument1, argument2..., argumentn)
    -- å‡½æ•°ä½“
    return è¿”å›å€¼
end
```



ä¾‹å¦‚ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ‰“å°æ•°ç»„ï¼š

```lua
function printArr(arr)
    for index, value in ipairs(arr) do
        print(value)
    end
end
```



#### æ¡ä»¶æ§åˆ¶

ç±»ä¼¼Javaçš„æ¡ä»¶æ§åˆ¶ï¼Œä¾‹å¦‚ifã€elseè¯­æ³•ï¼š

```lua
if(å¸ƒå°”è¡¨è¾¾å¼)
then
   --[ å¸ƒå°”è¡¨è¾¾å¼ä¸º true æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]
else
   --[ å¸ƒå°”è¡¨è¾¾å¼ä¸º false æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]
end

```



ä¸javaä¸åŒï¼Œå¸ƒå°”è¡¨è¾¾å¼ä¸­çš„é€»è¾‘è¿ç®—æ˜¯åŸºäºè‹±æ–‡å•è¯ï¼š

![image-20210821092657918](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131790.png)

#### æ¡ˆä¾‹

éœ€æ±‚ï¼šè‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥æ‰“å°tableï¼Œå½“å‚æ•°ä¸ºnilæ—¶ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯

```lua
function printArr(arr)
    if not arr then
        print('æ•°ç»„ä¸èƒ½ä¸ºç©ºï¼')
    end
    for index, value in ipairs(arr) do
        print(value)
    end
end
```

## å®ç°å¤šçº§ç¼“å­˜

å¤šçº§ç¼“å­˜çš„å®ç°ç¦»ä¸å¼€Nginxç¼–ç¨‹ï¼Œè€ŒNginxç¼–ç¨‹åˆç¦»ä¸å¼€OpenRestyã€‚

### å®‰è£…OpenResty

OpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginxçš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š

- å…·å¤‡Nginxçš„å®Œæ•´åŠŸèƒ½
- åŸºäºLuaè¯­è¨€è¿›è¡Œæ‰©å±•ï¼Œé›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—
- å…è®¸ä½¿ç”¨Lua**è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘**ã€**è‡ªå®šä¹‰åº“**

**1. å®‰è£…å¼€å‘åº“**

é¦–å…ˆè¦å®‰è£…OpenRestyçš„ä¾èµ–å¼€å‘åº“ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š

```sh
yum install -y pcre-devel openssl-devel gcc --skip-broken
```



**2. å®‰è£…OpenRestyä»“åº“**

å¯ä»¥åœ¨è‡ªå·±çš„ CentOS ç³»ç»Ÿä¸­æ·»åŠ  `openresty` ä»“åº“ï¼Œè¿™æ ·å°±å¯ä»¥ä¾¿äºæœªæ¥å®‰è£…æˆ–æ›´æ–°æˆ‘ä»¬çš„è½¯ä»¶åŒ…ï¼ˆé€šè¿‡ `yum check-update` å‘½ä»¤ï¼‰ã€‚è¿è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥æ·»åŠ æˆ‘ä»¬çš„ä»“åº“ï¼š

```
yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo
```



å¦‚æœæç¤ºè¯´å‘½ä»¤ä¸å­˜åœ¨ï¼Œåˆ™è¿è¡Œï¼š

```
yum install -y yum-utils 
```

ç„¶åå†é‡å¤ä¸Šé¢çš„å‘½ä»¤

**3. å®‰è£…OpenResty**

ç„¶åå°±å¯ä»¥åƒä¸‹é¢è¿™æ ·å®‰è£…è½¯ä»¶åŒ…ï¼Œæ¯”å¦‚ `openresty`ï¼š

```bash
yum install -y openresty
```

**4. å®‰è£…opmå·¥å…·**

opmæ˜¯OpenRestyçš„ä¸€ä¸ªç®¡ç†å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®‰è£…ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„Luaæ¨¡å—ã€‚

å¦‚æœä½ æƒ³å®‰è£…å‘½ä»¤è¡Œå·¥å…· `opm`ï¼Œé‚£ä¹ˆå¯ä»¥åƒä¸‹é¢è¿™æ ·å®‰è£… `openresty-opm` åŒ…ï¼š

```bash
yum install -y openresty-opm
```

**5. ç›®å½•ç»“æ„***

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenRestyå®‰è£…çš„ç›®å½•æ˜¯ï¼š/usr/local/openresty

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212132207480.png" alt="image-20200310225539214" style="zoom:50%;" /> 

çœ‹åˆ°é‡Œé¢çš„nginxç›®å½•äº†å—ï¼ŒOpenRestyå°±æ˜¯åœ¨NginxåŸºç¡€ä¸Šé›†æˆäº†ä¸€äº›Luaæ¨¡å—ã€‚

**6. é…ç½®nginxçš„ç¯å¢ƒå˜é‡**

æ‰“å¼€é…ç½®æ–‡ä»¶ï¼š

```sh
vi /etc/profile
```

åœ¨æœ€ä¸‹é¢åŠ å…¥ä¸¤è¡Œï¼š

```sh
export NGINX_HOME=/usr/local/openresty/nginx
export PATH=${NGINX_HOME}/sbin:$PATH
```

NGINX_HOMEï¼šåé¢æ˜¯OpenRestyå®‰è£…ç›®å½•ä¸‹çš„nginxçš„ç›®å½•

ç„¶åè®©é…ç½®ç”Ÿæ•ˆï¼š

```
source /etc/profile
```

#### å¯åŠ¨å’Œè¿è¡ŒOpenResty

OpenResty åº•å±‚æ˜¯åŸºäºNginxçš„ï¼ŒæŸ¥çœ‹ OpenResty ç›®å½•çš„ nginx ç›®å½•ï¼Œç»“æ„ä¸windowsä¸­å®‰è£…çš„nginxåŸºæœ¬ä¸€è‡´ï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212132207629.png" alt="image-20210811100653291" style="zoom:67%;" />

æ‰€ä»¥è¿è¡Œæ–¹å¼ä¸nginxåŸºæœ¬ä¸€è‡´ï¼š

```sh
# å¯åŠ¨nginx
nginx
# é‡æ–°åŠ è½½é…ç½®
nginx -s reload
# åœæ­¢
nginx -s stop
```



nginxçš„é»˜è®¤é…ç½®æ–‡ä»¶æ³¨é‡Šå¤ªå¤šï¼Œå½±å“åç»­æˆ‘ä»¬çš„ç¼–è¾‘ï¼Œè¿™é‡Œå°†nginx.confä¸­çš„æ³¨é‡Šéƒ¨åˆ†åˆ é™¤ï¼Œä¿ç•™æœ‰æ•ˆéƒ¨åˆ†ã€‚

ä¿®æ”¹`/usr/local/openresty/nginx/conf/nginx.conf`æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```nginx
#user  nobody;
worker_processes  1;
error_log  logs/error.log;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       8081;
        server_name  localhost;
        location / {
            root   html;
            index  index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
```

åœ¨Linuxçš„æ§åˆ¶å°è¾“å…¥å‘½ä»¤ä»¥å¯åŠ¨nginxï¼š

```sh
nginx
```

#### å¤‡æ³¨

åŠ è½½OpenRestyçš„luaæ¨¡å—ï¼š

```nginx
#lua æ¨¡å—
lua_package_path "/usr/local/openresty/lualib/?.lua;;";
#cæ¨¡å—     
lua_package_cpath "/usr/local/openresty/lualib/?.so;;";  
```



**common.lua**

```lua
-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº”
local function read_http(path, params)
    local resp = ngx.location.capture(path,{
        method = ngx.HTTP_GET,
        args = params,
    })
    if not resp then
        -- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404
        ngx.log(ngx.ERR, "http not found, path: ", path , ", args: ", args)
        ngx.exit(404)
    end
    return resp.body
end
-- å°†æ–¹æ³•å¯¼å‡º
local _M = {  
    read_http = read_http
}  
return _M
```



**é‡Šæ”¾Redisè¿æ¥APIï¼š**

```lua
-- å…³é—­redisè¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± 
local function close_redis(red)
    local pool_max_idle_time = 10000 -- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
    local pool_size = 100 --è¿æ¥æ± å¤§å°
    local ok, err = red:set_keepalive(pool_max_idle_time, pool_size)
    if not ok then
        ngx.log(ngx.ERR, "æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: ", err)
    end
end
```

**è¯»å–Redisæ•°æ®çš„APIï¼š**

```lua
-- æŸ¥è¯¢redisçš„æ–¹æ³• ipå’Œportæ˜¯redisåœ°å€ï¼Œkeyæ˜¯æŸ¥è¯¢çš„key
local function read_redis(ip, port, key)
    -- è·å–ä¸€ä¸ªè¿æ¥
    local ok, err = red:connect(ip, port)
    if not ok then
        ngx.log(ngx.ERR, "è¿æ¥rediså¤±è´¥ : ", err)
        return nil
    end
    -- æŸ¥è¯¢redis
    local resp, err = red:get(key)
    -- æŸ¥è¯¢å¤±è´¥å¤„ç†
    if not resp then
        ngx.log(ngx.ERR, "æŸ¥è¯¢Rediså¤±è´¥: ", err, ", key = " , key)
    end
    --å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†
    if resp == ngx.null then
        resp = nil
        ngx.log(ngx.ERR, "æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = ", key)
    end
    close_redis(red)
    return resp
end
```



**å¼€å¯å…±äº«è¯å…¸ï¼š**

```nginx
# å…±äº«å­—å…¸ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåç§°å«åšï¼šitem_cacheï¼Œå¤§å°150m
lua_shared_dict item_cache 150m;Â 
```

### OpenRestyå¿«é€Ÿå…¥é—¨

æˆ‘ä»¬å¸Œæœ›è¾¾åˆ°çš„å¤šçº§ç¼“å­˜æ¶æ„å¦‚å›¾ï¼š

![yeVDlwtfMx](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131179.png)

å…¶ä¸­ï¼š

- windowsä¸Šçš„nginxç”¨æ¥åšåå‘ä»£ç†æœåŠ¡ï¼Œå°†å‰ç«¯çš„æŸ¥è¯¢å•†å“çš„ajaxè¯·æ±‚ä»£ç†åˆ°OpenRestyé›†ç¾¤

- OpenRestyé›†ç¾¤ç”¨æ¥ç¼–å†™å¤šçº§ç¼“å­˜ä¸šåŠ¡

#### åå‘ä»£ç†æµç¨‹

ç°åœ¨ï¼Œå•†å“è¯¦æƒ…é¡µä½¿ç”¨çš„æ˜¯å‡çš„å•†å“æ•°æ®ã€‚ä¸è¿‡åœ¨æµè§ˆå™¨ä¸­ï¼Œå¯ä»¥çœ‹åˆ°é¡µé¢æœ‰å‘èµ·ajaxè¯·æ±‚æŸ¥è¯¢çœŸå®å•†å“æ•°æ®ã€‚

è¿™ä¸ªè¯·æ±‚å¦‚ä¸‹ï¼š

![image-20210821093144700](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131187.png)

è¯·æ±‚åœ°å€æ˜¯localhostï¼Œç«¯å£æ˜¯80ï¼Œå°±è¢«windowsä¸Šå®‰è£…çš„NginxæœåŠ¡ç»™æ¥æ”¶åˆ°äº†ã€‚ç„¶åä»£ç†ç»™äº†OpenRestyé›†ç¾¤ï¼š

![image-20210821094447709](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131198.png)

æˆ‘ä»¬éœ€è¦åœ¨OpenRestyä¸­ç¼–å†™ä¸šåŠ¡ï¼ŒæŸ¥è¯¢å•†å“æ•°æ®å¹¶è¿”å›åˆ°æµè§ˆå™¨ã€‚

ä½†æ˜¯è¿™æ¬¡ï¼Œæˆ‘ä»¬å…ˆåœ¨OpenRestyæ¥æ”¶è¯·æ±‚ï¼Œè¿”å›å‡çš„å•†å“æ•°æ®ã€‚

#### OpenRestyç›‘å¬è¯·æ±‚

OpenRestyçš„å¾ˆå¤šåŠŸèƒ½éƒ½ä¾èµ–äºå…¶ç›®å½•ä¸‹çš„Luaåº“ï¼Œéœ€è¦åœ¨nginx.confä¸­æŒ‡å®šä¾èµ–åº“çš„ç›®å½•ï¼Œå¹¶å¯¼å…¥ä¾èµ–ï¼š

**1. æ·»åŠ å¯¹OpenRestyçš„Luaæ¨¡å—çš„åŠ è½½**

ä¿®æ”¹`/usr/local/openresty/nginx/conf/nginx.conf`æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­çš„httpä¸‹é¢ï¼Œæ·»åŠ ä¸‹é¢ä»£ç ï¼š

```nginx
#lua æ¨¡å—
lua_package_path "/usr/local/openresty/lualib/?.lua;;";
#cæ¨¡å—     
lua_package_cpath "/usr/local/openresty/lualib/?.so;;";  
```



**2. ç›‘å¬/api/itemè·¯å¾„**

ä¿®æ”¹`/usr/local/openresty/nginx/conf/nginx.conf`æ–‡ä»¶ï¼Œåœ¨nginx.confçš„serverä¸‹é¢ï¼Œæ·»åŠ å¯¹/api/itemè¿™ä¸ªè·¯å¾„çš„ç›‘å¬ï¼š

```nginx
location  /api/item {
    # é»˜è®¤çš„å“åº”ç±»å‹
    default_type application/json;
    # å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š
    content_by_lua_file lua/item.lua;
}
```



è¿™ä¸ªç›‘å¬ï¼Œå°±ç±»ä¼¼äºSpringMVCä¸­çš„`@GetMapping("/api/item")`åšè·¯å¾„æ˜ å°„ã€‚

è€Œ`content_by_lua_file lua/item.lua`åˆ™ç›¸å½“äºè°ƒç”¨item.luaè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰§è¡Œå…¶ä¸­çš„ä¸šåŠ¡ï¼ŒæŠŠç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚ç›¸å½“äºjavaä¸­è°ƒç”¨serviceã€‚

#### ç¼–å†™item.lua

**1. åœ¨`/usr/loca/openresty/nginx`ç›®å½•åˆ›å»ºæ–‡ä»¶å¤¹ï¼šlua**

![image-20210821100755080](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131205.png)

**2. åœ¨`/usr/loca/openresty/nginx/lua`æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶ï¼šitem.lua**

![image-20210821100801756](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131552.png)



**3. ç¼–å†™item.luaï¼Œè¿”å›å‡æ•°æ®**

item.luaä¸­ï¼Œåˆ©ç”¨ngx.say()å‡½æ•°è¿”å›æ•°æ®åˆ°Responseä¸­

```lua
ngx.say('{"id":10001,"name":"SALSA AIR","title":"RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4","price":17900,"image":"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp","category":"æ‹‰æ†ç®±","brand":"RIMOWA","spec":"","status":1,"createTime":"2019-04-30T16:00:00.000+00:00","updateTime":"2019-04-30T16:00:00.000+00:00","stock":2999,"sold":31290}')
```



**4. é‡æ–°åŠ è½½é…ç½®**

```sh
nginx -s reload
```

### è¯·æ±‚å‚æ•°å¤„ç†

OpenResty è·å–å‰ç«¯ä¼ é€’çš„å•†å“å‚æ•°å‘¢ï¼Ÿ

#### è·å–å‚æ•°çš„API

OpenRestyä¸­æä¾›äº†ä¸€äº›APIç”¨æ¥è·å–ä¸åŒç±»å‹çš„å‰ç«¯è¯·æ±‚å‚æ•°ï¼š

![image-20210821101433528](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131607.png)

#### è·å–å‚æ•°å¹¶è¿”å›

åœ¨å‰ç«¯å‘èµ·çš„ajaxè¯·æ±‚å¦‚å›¾ï¼š

![image-20210821101721649](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131619.png)

å¯ä»¥çœ‹åˆ°å•†å“idæ˜¯ä»¥è·¯å¾„å ä½ç¬¦æ–¹å¼ä¼ é€’çš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æ–¹å¼æ¥è·å–ID

**1. è·å–å•†å“id**

ä¿®æ”¹`/usr/loca/openresty/nginx/nginx.conf`æ–‡ä»¶ä¸­ç›‘å¬/api/itemçš„ä»£ç ï¼Œåˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼è·å–IDï¼š

```nginx
location ~ /api/item/(\d+) {
    # é»˜è®¤çš„å“åº”ç±»å‹
    default_type application/json;
    # å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š
    content_by_lua_file lua/item.lua;
}
```



**2. æ‹¼æ¥IDå¹¶è¿”å›**

ä¿®æ”¹`/usr/loca/openresty/nginx/lua/item.lua`æ–‡ä»¶ï¼Œè·å–idå¹¶æ‹¼æ¥åˆ°ç»“æœä¸­è¿”å›ï¼š

```lua
-- è·å–å•†å“id
local id = ngx.var[1]
-- æ‹¼æ¥å¹¶è¿”å›
ngx.say('{"id":' .. id .. ',"name":"SALSA AIR","title":"RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4","price":17900,"image":"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp","category":"æ‹‰æ†ç®±","brand":"RIMOWA","spec":"","status":1,"createTime":"2019-04-30T16:00:00.000+00:00","updateTime":"2019-04-30T16:00:00.000+00:00","stock":2999,"sold":31290}')
```



**3. é‡æ–°åŠ è½½å¹¶æµ‹è¯•**

è¿è¡Œå‘½ä»¤ä»¥é‡æ–°åŠ è½½OpenRestyé…ç½®ï¼š

```sh
nginx -s reload
```



åˆ·æ–°é¡µé¢å¯ä»¥çœ‹åˆ°ç»“æœä¸­å·²ç»å¸¦ä¸Šäº†IDï¼š

![image-20210821102235467](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131624.png) 

### æŸ¥è¯¢Tomcat

æ‹¿åˆ°å•†å“IDåï¼Œæœ¬åº”å»ç¼“å­˜ä¸­æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œä¸è¿‡ç›®å‰æˆ‘ä»¬è¿˜æœªå»ºç«‹nginxã€redisç¼“å­˜ã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ ¹æ®å•†å“idå»tomcatæŸ¥è¯¢å•†å“ä¿¡æ¯ã€‚æˆ‘ä»¬å®ç°å¦‚å›¾éƒ¨åˆ†ï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131631.png" alt="image-20210821102610167" style="zoom:50%;" />



éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„OpenRestyæ˜¯åœ¨è™šæ‹Ÿæœºï¼ŒTomcatæ˜¯åœ¨Windowsç”µè„‘ä¸Šã€‚ä¸¤è€…IPä¸€å®šä¸è¦æé”™äº†ã€‚

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131131732.png" alt="image-20210821102959829" style="zoom:50%;" />

#### å‘é€httpè¯·æ±‚çš„API

nginxæä¾›äº†å†…éƒ¨APIç”¨ä»¥å‘é€httpè¯·æ±‚ï¼š

```lua
local resp = ngx.location.capture("/path",{
    method = ngx.HTTP_GET,   -- è¯·æ±‚æ–¹å¼
    args = {a=1,b=2},  -- getæ–¹å¼ä¼ å‚æ•°
})
```

è¿”å›çš„å“åº”å†…å®¹åŒ…æ‹¬ï¼š

- resp.statusï¼šå“åº”çŠ¶æ€ç 
- resp.headerï¼šå“åº”å¤´ï¼Œæ˜¯ä¸€ä¸ªtable
- resp.bodyï¼šå“åº”ä½“ï¼Œå°±æ˜¯å“åº”æ•°æ®

æ³¨æ„ï¼šè¿™é‡Œçš„pathæ˜¯è·¯å¾„ï¼Œå¹¶ä¸åŒ…å«IPå’Œç«¯å£ã€‚è¿™ä¸ªè¯·æ±‚ä¼šè¢«nginxå†…éƒ¨çš„serverç›‘å¬å¹¶å¤„ç†ã€‚

ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªè¯·æ±‚å‘é€åˆ°TomcatæœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ªserveræ¥å¯¹è¿™ä¸ªè·¯å¾„åšåå‘ä»£ç†ï¼š

```nginx
 location /path {
     # è¿™é‡Œæ˜¯windowsç”µè„‘çš„ipå’ŒJavaæœåŠ¡ç«¯å£ï¼Œéœ€è¦ç¡®ä¿windowsé˜²ç«å¢™å¤„äºå…³é—­çŠ¶æ€
     proxy_pass http://192.168.150.1:8081; 
 }
```



åŸç†å¦‚å›¾ï¼š

![image-20210821104149061](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132184.png)

#### å°è£…httpå·¥å…·

ä¸‹é¢ï¼Œæˆ‘ä»¬å°è£…ä¸€ä¸ªå‘é€Httpè¯·æ±‚çš„å·¥å…·ï¼ŒåŸºäºngx.location.captureæ¥å®ç°æŸ¥è¯¢tomcatã€‚



**1. æ·»åŠ åå‘ä»£ç†ï¼Œåˆ°windowsçš„JavaæœåŠ¡**

å› ä¸ºitem-serviceä¸­çš„æ¥å£éƒ½æ˜¯/itemå¼€å¤´ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›‘å¬/itemè·¯å¾„ï¼Œä»£ç†åˆ°windowsä¸Šçš„tomcatæœåŠ¡ã€‚

ä¿®æ”¹ `/usr/local/openresty/nginx/conf/nginx.conf`æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªlocationï¼š

```nginx
location /item {
    proxy_pass http://192.168.150.1:8081;
}
```

ä»¥åï¼Œåªè¦æˆ‘ä»¬è°ƒç”¨`ngx.location.capture("/item")`ï¼Œå°±ä¸€å®šèƒ½å‘é€è¯·æ±‚åˆ°windowsçš„tomcatæœåŠ¡ã€‚



**2. å°è£…å·¥å…·ç±»**

ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒOpenRestyå¯åŠ¨æ—¶ä¼šåŠ è½½ä»¥ä¸‹ä¸¤ä¸ªç›®å½•ä¸­çš„å·¥å…·æ–‡ä»¶ï¼š

![image-20210821104857413](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132192.png)

æ‰€ä»¥ï¼Œè‡ªå®šä¹‰çš„httpå·¥å…·ä¹Ÿéœ€è¦æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚

åœ¨`/usr/local/openresty/lualib`ç›®å½•ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªcommon.luaæ–‡ä»¶ï¼š

```sh
vi /usr/local/openresty/lualib/common.lua
```

å†…å®¹å¦‚ä¸‹:

```lua
-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº”
local function read_http(path, params)
    local resp = ngx.location.capture(path,{
        method = ngx.HTTP_GET,
        args = params,
    })
    if not resp then
        -- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404
        ngx.log(ngx.ERR, "httpè¯·æ±‚æŸ¥è¯¢å¤±è´¥, path: ", path , ", args: ", args)
        ngx.exit(404)
    end
    return resp.body
end
-- å°†æ–¹æ³•å¯¼å‡º
local _M = {  
    read_http = read_http
}  
return _M
```



è¿™ä¸ªå·¥å…·å°†read_httpå‡½æ•°å°è£…åˆ°_Mè¿™ä¸ªtableç±»å‹çš„å˜é‡ä¸­ï¼Œå¹¶ä¸”è¿”å›ï¼Œè¿™ç±»ä¼¼äºå¯¼å‡ºã€‚

ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥åˆ©ç”¨`require('common')`æ¥å¯¼å…¥è¯¥å‡½æ•°åº“ï¼Œè¿™é‡Œçš„commonæ˜¯å‡½æ•°åº“çš„æ–‡ä»¶åã€‚



**3. å®ç°å•†å“æŸ¥è¯¢**

æœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹`/usr/local/openresty/lua/item.lua`æ–‡ä»¶ï¼Œåˆ©ç”¨åˆšåˆšå°è£…çš„å‡½æ•°åº“å®ç°å¯¹tomcatçš„æŸ¥è¯¢ï¼š

```lua
-- å¼•å…¥è‡ªå®šä¹‰commonå·¥å…·æ¨¡å—ï¼Œè¿”å›å€¼æ˜¯commonä¸­è¿”å›çš„ _M
local common = require("common")
-- ä» commonä¸­è·å–read_httpè¿™ä¸ªå‡½æ•°
local read_http = common.read_http
-- è·å–è·¯å¾„å‚æ•°
local id = ngx.var[1]
-- æ ¹æ®idæŸ¥è¯¢å•†å“
local itemJSON = read_http("/item/".. id, nil)
-- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜
local itemStockJSON = read_http("/item/stock/".. id, nil)
```



è¿™é‡ŒæŸ¥è¯¢åˆ°çš„ç»“æœæ˜¯jsonå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”åŒ…å«å•†å“ã€åº“å­˜ä¸¤ä¸ªjsonå­—ç¬¦ä¸²ï¼Œé¡µé¢æœ€ç»ˆéœ€è¦çš„æ˜¯æŠŠä¸¤ä¸ªjsonæ‹¼æ¥ä¸ºä¸€ä¸ªjsonï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132194.png" alt="image-20210821110441222" style="zoom:50%;" />



è¿™å°±éœ€è¦æˆ‘ä»¬å…ˆæŠŠJSONå˜ä¸ºluaçš„tableï¼Œå®Œæˆæ•°æ®æ•´åˆåï¼Œå†è½¬ä¸ºJSONã€‚

#### CJSONå·¥å…·ç±»

OpenResty æä¾›äº†ä¸€ä¸ª cjson çš„æ¨¡å—ç”¨æ¥å¤„ç†JSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

å®˜æ–¹åœ°å€ï¼š https://github.com/openresty/lua-cjson/

**1. å¼•å…¥cjsonæ¨¡å—ï¼š**

```lua
local cjson = require "cjson"
```



**2. åºåˆ—åŒ–ï¼š**

```lua
local obj = {
    name = 'jack',
    age = 21
}
-- æŠŠ table åºåˆ—åŒ–ä¸º json
local json = cjson.encode(obj)
```



**3. ååºåˆ—åŒ–ï¼š**

```lua
local json = '{"name": "jack", "age": 21}'
-- ååºåˆ—åŒ– jsonä¸º table
local obj = cjson.decode(json);
print(obj.name)
```

####  å®ç°TomcatæŸ¥è¯¢

ä¸‹é¢ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¹‹å‰çš„item.luaä¸­çš„ä¸šåŠ¡ï¼Œæ·»åŠ jsonå¤„ç†åŠŸèƒ½ï¼š

```lua
-- å¯¼å…¥commonå‡½æ•°åº“
local common = require('common')
local read_http = common.read_http
-- å¯¼å…¥cjsonåº“
local cjson = require('cjson')

-- è·å–è·¯å¾„å‚æ•°
local id = ngx.var[1]
-- æ ¹æ®idæŸ¥è¯¢å•†å“
local itemJSON = read_http("/item/".. id, nil)
-- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜
local itemStockJSON = read_http("/item/stock/".. id, nil)

-- JSONè½¬åŒ–ä¸ºluaçš„table
local item = cjson.decode(itemJSON)
local stock = cjson.decode(stockJSON)

-- ç»„åˆæ•°æ®
item.stock = stock.stock
item.sold = stock.sold

-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ
ngx.say(cjson.encode(item))
```

#### åŸºäºIDè´Ÿè½½å‡è¡¡

åˆšæ‰çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çš„tomcatæ˜¯å•æœºéƒ¨ç½²ã€‚è€Œå®é™…å¼€å‘ä¸­ï¼Œtomcatä¸€å®šæ˜¯é›†ç¾¤æ¨¡å¼ï¼š

![image-20210821111023255](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132204.png)

å› æ­¤ï¼ŒOpenRestyéœ€è¦å¯¹tomcaté›†ç¾¤åšè´Ÿè½½å‡è¡¡ã€‚

è€Œé»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™æ˜¯è½®è¯¢æ¨¡å¼ï¼Œå½“æˆ‘ä»¬æŸ¥è¯¢/item/10001æ—¶ï¼š

- ç¬¬ä¸€æ¬¡ä¼šè®¿é—®8081ç«¯å£çš„tomcatæœåŠ¡ï¼Œåœ¨è¯¥æœåŠ¡å†…éƒ¨å°±å½¢æˆäº†JVMè¿›ç¨‹ç¼“å­˜
- ç¬¬äºŒæ¬¡ä¼šè®¿é—®8082ç«¯å£çš„tomcatæœåŠ¡ï¼Œè¯¥æœåŠ¡å†…éƒ¨æ²¡æœ‰JVMç¼“å­˜ï¼ˆå› ä¸ºJVMç¼“å­˜æ— æ³•å…±äº«ï¼‰ï¼Œä¼šæŸ¥è¯¢æ•°æ®åº“
- ...

å¦‚æœèƒ½è®©åŒä¸€ä¸ªå•†å“ï¼Œæ¯æ¬¡æŸ¥è¯¢æ—¶éƒ½è®¿é—®åŒä¸€ä¸ªtomcatæœåŠ¡ï¼Œé‚£ä¹ˆJVMç¼“å­˜å°±ä¸€å®šèƒ½ç”Ÿæ•ˆäº†ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å•†å“idåšè´Ÿè½½å‡è¡¡ï¼Œè€Œä¸æ˜¯è½®è¯¢ã€‚



**1. åŸç†**

nginxæä¾›äº†åŸºäºè¯·æ±‚è·¯å¾„åšè´Ÿè½½å‡è¡¡çš„ç®—æ³•ï¼š

nginxæ ¹æ®è¯·æ±‚è·¯å¾„åšhashè¿ç®—ï¼ŒæŠŠå¾—åˆ°çš„æ•°å€¼å¯¹tomcatæœåŠ¡çš„æ•°é‡å–ä½™ï¼Œä½™æ•°æ˜¯å‡ ï¼Œå°±è®¿é—®ç¬¬å‡ ä¸ªæœåŠ¡ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

ğŸŒ°ï¼š

- æˆ‘ä»¬çš„è¯·æ±‚è·¯å¾„æ˜¯ /item/10001
- tomcatæ€»æ•°ä¸º2å°ï¼ˆ8081ã€8082ï¼‰
- å¯¹è¯·æ±‚è·¯å¾„/item/1001åšhashè¿ç®—æ±‚ä½™çš„ç»“æœä¸º1
- åˆ™è®¿é—®ç¬¬ä¸€ä¸ªtomcatæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯8081

åªè¦idä¸å˜ï¼Œæ¯æ¬¡hashè¿ç®—ç»“æœä¹Ÿä¸ä¼šå˜ï¼Œé‚£å°±å¯ä»¥ä¿è¯åŒä¸€ä¸ªå•†å“ï¼Œä¸€ç›´è®¿é—®åŒä¸€ä¸ªtomcatæœåŠ¡ï¼Œç¡®ä¿JVMç¼“å­˜ç”Ÿæ•ˆã€‚



**2. å®ç°**

ä¿®æ”¹`/usr/local/openresty/nginx/conf/nginx.conf`æ–‡ä»¶ï¼Œå®ç°åŸºäºIDåšè´Ÿè½½å‡è¡¡ã€‚

é¦–å…ˆï¼Œå®šä¹‰tomcaté›†ç¾¤ï¼Œå¹¶è®¾ç½®åŸºäºè·¯å¾„åšè´Ÿè½½å‡è¡¡ï¼š

```nginx 
upstream tomcat-cluster {
    hash $request_uri;
    server 192.168.150.1:8081;
    server 192.168.150.1:8082;
}
```

ç„¶åï¼Œä¿®æ”¹å¯¹tomcatæœåŠ¡çš„åå‘ä»£ç†ï¼Œç›®æ ‡æŒ‡å‘tomcaté›†ç¾¤ï¼š

```nginx
location /item {
    proxy_pass http://tomcat-cluster;
}
```

é‡æ–°åŠ è½½OpenResty

```sh
nginx -s reload
```



**3. æµ‹è¯•**

å¯åŠ¨ä¸¤å°tomcatæœåŠ¡ï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132213.png" alt="image-20210821112420464" style="zoom: 50%;" />

åŒæ—¶å¯åŠ¨ï¼š

![image-20210821112444482](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132225.png) 

æ¸…ç©ºæ—¥å¿—åï¼Œå†æ¬¡è®¿é—®é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°ä¸åŒidçš„å•†å“ï¼Œè®¿é—®åˆ°äº†ä¸åŒçš„tomcatæœåŠ¡ï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132765.png" alt="image-20210821112559965" style="zoom:50%;" />

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132771.png" alt="image-20210821112637430" style="zoom:50%;" />

### Redisç¼“å­˜é¢„çƒ­

Redisç¼“å­˜ä¼šé¢ä¸´å†·å¯åŠ¨é—®é¢˜ï¼š

**å†·å¯åŠ¨**ï¼šæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼ŒRedisä¸­å¹¶æ²¡æœ‰ç¼“å­˜ï¼Œå¦‚æœæ‰€æœ‰å•†å“æ•°æ®éƒ½åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶æ·»åŠ ç¼“å­˜ï¼Œå¯èƒ½ä¼šç»™æ•°æ®åº“å¸¦æ¥è¾ƒå¤§å‹åŠ›ã€‚

**ç¼“å­˜é¢„çƒ­**ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¤§æ•°æ®ç»Ÿè®¡ç”¨æˆ·è®¿é—®çš„çƒ­ç‚¹æ•°æ®ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶å°†è¿™äº›çƒ­ç‚¹æ•°æ®æå‰æŸ¥è¯¢å¹¶ä¿å­˜åˆ°Redisä¸­ã€‚



æˆ‘ä»¬æ•°æ®é‡è¾ƒå°‘ï¼Œå¹¶ä¸”æ²¡æœ‰æ•°æ®ç»Ÿè®¡ç›¸å…³åŠŸèƒ½ï¼Œç›®å‰å¯ä»¥åœ¨å¯åŠ¨æ—¶å°†æ‰€æœ‰æ•°æ®éƒ½æ”¾å…¥ç¼“å­˜ä¸­ã€‚



**1. åˆ©ç”¨Dockerå®‰è£…Redis**

```sh
docker run --name redis -p 6379:6379 -d redis redis-server --appendonly yes
```



**2. åœ¨item-serviceæœåŠ¡ä¸­å¼•å…¥Redisä¾èµ–**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```



**3. é…ç½®Redisåœ°å€**

```yaml
spring:
  redis:
    host: 192.168.150.101
```



**4. ç¼–å†™åˆå§‹åŒ–ç±»**

ç¼“å­˜é¢„çƒ­éœ€è¦åœ¨é¡¹ç›®å¯åŠ¨æ—¶å®Œæˆï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æ‹¿åˆ° RedisTemplate ä¹‹åã€‚

è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ InitializingBea æ¥å£æ¥å®ç°ï¼Œå› ä¸º InitializingBean å¯ä»¥åœ¨å¯¹è±¡è¢«Springåˆ›å»ºå¹¶ä¸”æˆå‘˜å˜é‡å…¨éƒ¨æ³¨å…¥åæ‰§è¡Œã€‚

```java
package com.heima.item.config;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.heima.item.pojo.Item;
import com.heima.item.pojo.ItemStock;
import com.heima.item.service.IItemService;
import com.heima.item.service.IItemStockService;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
public class RedisHandler implements InitializingBean {

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Autowired
    private IItemService itemService;
    @Autowired
    private IItemStockService stockService;

    private static final ObjectMapper MAPPER = new ObjectMapper();

    @Override
    public void afterPropertiesSet() throws Exception {
        // åˆå§‹åŒ–ç¼“å­˜
        // 1.æŸ¥è¯¢å•†å“ä¿¡æ¯
        List<Item> itemList = itemService.list();
        // 2.æ”¾å…¥ç¼“å­˜
        for (Item item : itemList) {
            // 2.1.itemåºåˆ—åŒ–ä¸ºJSON
            String json = MAPPER.writeValueAsString(item);
            // 2.2.å­˜å…¥redis
            redisTemplate.opsForValue().set("item:id:" + item.getId(), json);
        }

        // 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯
        List<ItemStock> stockList = stockService.list();
        // 4.æ”¾å…¥ç¼“å­˜
        for (ItemStock stock : stockList) {
            // 2.1.itemåºåˆ—åŒ–ä¸ºJSON
            String json = MAPPER.writeValueAsString(stock);
            // 2.2.å­˜å…¥redis
            redisTemplate.opsForValue().set("item:stock:id:" + stock.getId(), json);
        }
    }
}
```

### æŸ¥è¯¢Redisç¼“å­˜

ç°åœ¨ï¼ŒRedisç¼“å­˜å·²ç»å‡†å¤‡å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥å†OpenRestyä¸­å®ç°æŸ¥è¯¢Redisçš„é€»è¾‘äº†ã€‚å¦‚ä¸‹å›¾çº¢æ¡†æ‰€ç¤ºï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132772.png" alt="image-20210821113340111" style="zoom:50%;" />

å½“è¯·æ±‚è¿›å…¥OpenRestyä¹‹åï¼š

- ä¼˜å…ˆæŸ¥è¯¢Redisç¼“å­˜
- å¦‚æœRedisç¼“å­˜æœªå‘½ä¸­ï¼Œå†æŸ¥è¯¢Tomcat

#### å°è£…Rediså·¥å…·

OpenRestyæä¾›äº†æ“ä½œRedisçš„æ¨¡å—ï¼Œæˆ‘ä»¬åªè¦å¼•å…¥è¯¥æ¨¡å—å°±èƒ½ç›´æ¥ä½¿ç”¨ã€‚ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†Redisæ“ä½œå°è£…åˆ°ä¹‹å‰çš„common.luaå·¥å…·åº“ä¸­ã€‚

ä¿®æ”¹`/usr/local/openresty/lualib/common.lua`æ–‡ä»¶ï¼š

**1. å¼•å…¥Redisæ¨¡å—ï¼Œå¹¶åˆå§‹åŒ–Rediså¯¹è±¡**

```lua
-- å¯¼å…¥redis
local redis = require('resty.redis')
-- åˆå§‹åŒ–redis
local red = redis:new()
red:set_timeouts(1000, 1000, 1000)
```



**2. å°è£…å‡½æ•°ï¼Œç”¨æ¥é‡Šæ”¾Redisè¿æ¥ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± **

```lua
-- å…³é—­redisè¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± 
local function close_redis(red)
    local pool_max_idle_time = 10000 -- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
    local pool_size = 100 --è¿æ¥æ± å¤§å°
    local ok, err = red:set_keepalive(pool_max_idle_time, pool_size)
    if not ok then
        ngx.log(ngx.ERR, "æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: ", err)
    end
end
```



**3. å°è£…å‡½æ•°ï¼Œæ ¹æ®keyæŸ¥è¯¢Redisæ•°æ®**

```lua
-- æŸ¥è¯¢redisçš„æ–¹æ³• ipå’Œportæ˜¯redisåœ°å€ï¼Œkeyæ˜¯æŸ¥è¯¢çš„key
local function read_redis(ip, port, key)
    -- è·å–ä¸€ä¸ªè¿æ¥
    local ok, err = red:connect(ip, port)
    if not ok then
        ngx.log(ngx.ERR, "è¿æ¥rediså¤±è´¥ : ", err)
        return nil
    end
    -- æŸ¥è¯¢redis
    local resp, err = red:get(key)
    -- æŸ¥è¯¢å¤±è´¥å¤„ç†
    if not resp then
        ngx.log(ngx.ERR, "æŸ¥è¯¢Rediså¤±è´¥: ", err, ", key = " , key)
    end
    --å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†
    if resp == ngx.null then
        resp = nil
        ngx.log(ngx.ERR, "æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = ", key)
    end
    close_redis(red)
    return resp
end
```



**4. å¯¼å‡º**

```lua
-- å°†æ–¹æ³•å¯¼å‡º
local _M = {  
    read_http = read_http,
    read_redis = read_redis
}  
return _M
```



**å®Œæ•´çš„common.luaï¼š**

```lua
-- å¯¼å…¥redis
local redis = require('resty.redis')
-- åˆå§‹åŒ–redis
local red = redis:new()
red:set_timeouts(1000, 1000, 1000)

-- å…³é—­redisè¿æ¥çš„å·¥å…·æ–¹æ³•ï¼Œå…¶å®æ˜¯æ”¾å…¥è¿æ¥æ± 
local function close_redis(red)
    local pool_max_idle_time = 10000 -- è¿æ¥çš„ç©ºé—²æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
    local pool_size = 100 --è¿æ¥æ± å¤§å°
    local ok, err = red:set_keepalive(pool_max_idle_time, pool_size)
    if not ok then
        ngx.log(ngx.ERR, "æ”¾å…¥redisè¿æ¥æ± å¤±è´¥: ", err)
    end
end

-- æŸ¥è¯¢redisçš„æ–¹æ³• ipå’Œportæ˜¯redisåœ°å€ï¼Œkeyæ˜¯æŸ¥è¯¢çš„key
local function read_redis(ip, port, key)
    -- è·å–ä¸€ä¸ªè¿æ¥
    local ok, err = red:connect(ip, port)
    if not ok then
        ngx.log(ngx.ERR, "è¿æ¥rediså¤±è´¥ : ", err)
        return nil
    end
    -- æŸ¥è¯¢redis
    local resp, err = red:get(key)
    -- æŸ¥è¯¢å¤±è´¥å¤„ç†
    if not resp then
        ngx.log(ngx.ERR, "æŸ¥è¯¢Rediså¤±è´¥: ", err, ", key = " , key)
    end
    --å¾—åˆ°çš„æ•°æ®ä¸ºç©ºå¤„ç†
    if resp == ngx.null then
        resp = nil
        ngx.log(ngx.ERR, "æŸ¥è¯¢Redisæ•°æ®ä¸ºç©º, key = ", key)
    end
    close_redis(red)
    return resp
end

-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº”
local function read_http(path, params)
    local resp = ngx.location.capture(path,{
        method = ngx.HTTP_GET,
        args = params,
    })
    if not resp then
        -- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404
        ngx.log(ngx.ERR, "httpæŸ¥è¯¢å¤±è´¥, path: ", path , ", args: ", args)
        ngx.exit(404)
    end
    return resp.body
end
-- å°†æ–¹æ³•å¯¼å‡º
local _M = {  
    read_http = read_http,
    read_redis = read_redis
}  
return _M
```

#### å®ç°RedisæŸ¥è¯¢

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ä¿®æ”¹item.luaæ–‡ä»¶ï¼Œå®ç°å¯¹Redisçš„æŸ¥è¯¢äº†ã€‚

æŸ¥è¯¢é€»è¾‘æ˜¯ï¼š

- æ ¹æ®idæŸ¥è¯¢Redis
- å¦‚æœæŸ¥è¯¢å¤±è´¥åˆ™ç»§ç»­æŸ¥è¯¢Tomcat
- å°†æŸ¥è¯¢ç»“æœè¿”å›

**1. ä¿®æ”¹`/usr/local/openresty/lua/item.lua`æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªæŸ¥è¯¢å‡½æ•°ï¼š**

```lua
-- å¯¼å…¥commonå‡½æ•°åº“
local common = require('common')
local read_http = common.read_http
local read_redis = common.read_redis
-- å°è£…æŸ¥è¯¢å‡½æ•°
function read_data(key, path, params)
    -- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
    local val = read_redis("127.0.0.1", 6379, key)
    -- åˆ¤æ–­æŸ¥è¯¢ç»“æœ
    if not val then
        ngx.log(ngx.ERR, "redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: ", key)
        -- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http
        val = read_http(path, params)
    end
    -- è¿”å›æ•°æ®
    return val
end
```



**2. è€Œåä¿®æ”¹å•†å“æŸ¥è¯¢ã€åº“å­˜æŸ¥è¯¢çš„ä¸šåŠ¡ï¼š**

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132791.png" alt="image-20210821114528954" style="zoom:50%;" />



**3. å®Œæ•´çš„item.luaä»£ç ï¼š**

```lua
-- å¯¼å…¥commonå‡½æ•°åº“
local common = require('common')
local read_http = common.read_http
local read_redis = common.read_redis
-- å¯¼å…¥cjsonåº“
local cjson = require('cjson')

-- å°è£…æŸ¥è¯¢å‡½æ•°
function read_data(key, path, params)
    -- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
    local val = read_redis("127.0.0.1", 6379, key)
    -- åˆ¤æ–­æŸ¥è¯¢ç»“æœ
    if not val then
        ngx.log(ngx.ERR, "redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: ", key)
        -- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http
        val = read_http(path, params)
    end
    -- è¿”å›æ•°æ®
    return val
end

-- è·å–è·¯å¾„å‚æ•°
local id = ngx.var[1]

-- æŸ¥è¯¢å•†å“ä¿¡æ¯
local itemJSON = read_data("item:id:" .. id,  "/item/" .. id, nil)
-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯
local stockJSON = read_data("item:stock:id:" .. id, "/item/stock/" .. id, nil)

-- JSONè½¬åŒ–ä¸ºluaçš„table
local item = cjson.decode(itemJSON)
local stock = cjson.decode(stockJSON)
-- ç»„åˆæ•°æ®
item.stock = stock.stock
item.sold = stock.sold

-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ
ngx.say(cjson.encode(item))
```

### Nginxæœ¬åœ°ç¼“å­˜

ç°åœ¨ï¼Œæ•´ä¸ªå¤šçº§ç¼“å­˜ä¸­åªå·®æœ€åä¸€ç¯ï¼Œä¹Ÿå°±æ˜¯nginxçš„æœ¬åœ°ç¼“å­˜äº†ã€‚å¦‚å›¾ï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132793.png" alt="image-20210821114742950" style="zoom:50%;" />

#### æœ¬åœ°ç¼“å­˜API

OpenRestyä¸ºNginxæä¾›äº†**shard dict**çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨nginxçš„å¤šä¸ªworkerä¹‹é—´å…±äº«æ•°æ®ï¼Œå®ç°ç¼“å­˜åŠŸèƒ½ã€‚

**1. å¼€å¯å…±äº«å­—å…¸ï¼Œåœ¨nginx.confçš„httpä¸‹æ·»åŠ é…ç½®ï¼š**

```nginx
 # å…±äº«å­—å…¸ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåç§°å«åšï¼šitem_cacheï¼Œå¤§å°150m
 lua_shared_dict item_cache 150m; 
```



**2. æ“ä½œå…±äº«å­—å…¸ï¼š**

```lua
-- è·å–æœ¬åœ°ç¼“å­˜å¯¹è±¡
local item_cache = ngx.shared.item_cache
-- å­˜å‚¨, æŒ‡å®škeyã€valueã€è¿‡æœŸæ—¶é—´ï¼Œå•ä½sï¼Œé»˜è®¤ä¸º0ä»£è¡¨æ°¸ä¸è¿‡æœŸ
item_cache:set('key', 'value', 1000)
-- è¯»å–
local val = item_cache:get('key')
```

#### å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢

**1. ä¿®æ”¹`/usr/local/openresty/lua/item.lua`æ–‡ä»¶ï¼Œä¿®æ”¹read_dataæŸ¥è¯¢å‡½æ•°ï¼Œæ·»åŠ æœ¬åœ°ç¼“å­˜é€»è¾‘ï¼š**

```lua
-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜
local item_cache = ngx.shared.item_cache

-- å°è£…æŸ¥è¯¢å‡½æ•°
function read_data(key, expire, path, params)
    -- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
    local val = item_cache:get(key)
    if not val then
        ngx.log(ngx.ERR, "æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: ", key)
        -- æŸ¥è¯¢redis
        val = read_redis("127.0.0.1", 6379, key)
        -- åˆ¤æ–­æŸ¥è¯¢ç»“æœ
        if not val then
            ngx.log(ngx.ERR, "redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: ", key)
            -- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http
            val = read_http(path, params)
        end
    end
    -- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜
    item_cache:set(key, val, expire)
    -- è¿”å›æ•°æ®
    return val
end
```





**2. ä¿®æ”¹item.luaä¸­æŸ¥è¯¢å•†å“å’Œåº“å­˜çš„ä¸šåŠ¡ï¼Œå®ç°æœ€æ–°çš„read_dataå‡½æ•°ï¼š**

![image-20210821115108528](https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132804.png)

å…¶å®å°±æ˜¯å¤šäº†ç¼“å­˜æ—¶é—´å‚æ•°ï¼Œè¿‡æœŸånginxç¼“å­˜ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œä¸‹æ¬¡è®¿é—®å³å¯æ›´æ–°ç¼“å­˜ã€‚

è¿™é‡Œç»™å•†å“åŸºæœ¬ä¿¡æ¯è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿï¼Œåº“å­˜ä¸º1åˆ†é’Ÿã€‚

å› ä¸ºåº“å­˜æ›´æ–°é¢‘ç‡è¾ƒé«˜ï¼Œå¦‚æœç¼“å­˜æ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½ä¸æ•°æ®åº“å·®å¼‚è¾ƒå¤§ã€‚



**3. å®Œæ•´çš„item.luaæ–‡ä»¶ï¼š**

```lua
-- å¯¼å…¥commonå‡½æ•°åº“
local common = require('common')
local read_http = common.read_http
local read_redis = common.read_redis
-- å¯¼å…¥cjsonåº“
local cjson = require('cjson')
-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜
local item_cache = ngx.shared.item_cache

-- å°è£…æŸ¥è¯¢å‡½æ•°
function read_data(key, expire, path, params)
    -- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
    local val = item_cache:get(key)
    if not val then
        ngx.log(ngx.ERR, "æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: ", key)
        -- æŸ¥è¯¢redis
        val = read_redis("127.0.0.1", 6379, key)
        -- åˆ¤æ–­æŸ¥è¯¢ç»“æœ
        if not val then
            ngx.log(ngx.ERR, "redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: ", key)
            -- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http
            val = read_http(path, params)
        end
    end
    -- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜
    item_cache:set(key, val, expire)
    -- è¿”å›æ•°æ®
    return val
end

-- è·å–è·¯å¾„å‚æ•°
local id = ngx.var[1]

-- æŸ¥è¯¢å•†å“ä¿¡æ¯
local itemJSON = read_data("item:id:" .. id, 1800,  "/item/" .. id, nil)
-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯
local stockJSON = read_data("item:stock:id:" .. id, 60, "/item/stock/" .. id, nil)

-- JSONè½¬åŒ–ä¸ºluaçš„table
local item = cjson.decode(itemJSON)
local stock = cjson.decode(stockJSON)
-- ç»„åˆæ•°æ®
item.stock = stock.stock
item.sold = stock.sold

-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ
ngx.say(cjson.encode(item))
```

## ç¼“å­˜åŒæ­¥

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨æŸ¥è¯¢åˆ°çš„éƒ½æ˜¯ç¼“å­˜æ•°æ®ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸æ•°æ®åº“æ•°æ®å­˜åœ¨è¾ƒå¤§å·®å¼‚ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ¯”è¾ƒä¸¥é‡çš„åæœã€‚

æ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä¿è¯æ•°æ®åº“æ•°æ®ã€ç¼“å­˜æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¸æ•°æ®åº“çš„åŒæ­¥ã€‚

### æ•°æ®åŒæ­¥ç­–ç•¥

ç¼“å­˜æ•°æ®åŒæ­¥çš„å¸¸è§æ–¹å¼æœ‰ä¸‰ç§ï¼š

**è®¾ç½®æœ‰æ•ˆæœŸ**ï¼šç»™ç¼“å­˜è®¾ç½®æœ‰æ•ˆæœŸï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ã€‚å†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°

- ä¼˜åŠ¿ï¼šç®€å•ã€æ–¹ä¾¿
- ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§å·®ï¼Œç¼“å­˜è¿‡æœŸä¹‹å‰å¯èƒ½ä¸ä¸€è‡´
- åœºæ™¯ï¼šæ›´æ–°é¢‘ç‡è¾ƒä½ï¼Œæ—¶æ•ˆæ€§è¦æ±‚ä½çš„ä¸šåŠ¡

**åŒæ­¥åŒå†™**ï¼šåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œç›´æ¥ä¿®æ”¹ç¼“å­˜

- ä¼˜åŠ¿ï¼šæ—¶æ•ˆæ€§å¼ºï¼Œç¼“å­˜ä¸æ•°æ®åº“å¼ºä¸€è‡´
- ç¼ºç‚¹ï¼šæœ‰ä»£ç ä¾µå…¥ï¼Œè€¦åˆåº¦é«˜ï¼›
- åœºæ™¯ï¼šå¯¹ä¸€è‡´æ€§ã€æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„ç¼“å­˜æ•°æ®

**å¼‚æ­¥é€šçŸ¥**ï¼šä¿®æ”¹æ•°æ®åº“æ—¶å‘é€äº‹ä»¶é€šçŸ¥ï¼Œç›¸å…³æœåŠ¡ç›‘å¬åˆ°é€šçŸ¥åä¿®æ”¹ç¼“å­˜æ•°æ®

- ä¼˜åŠ¿ï¼šä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡
- ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€
- åœºæ™¯ï¼šæ—¶æ•ˆæ€§è¦æ±‚ä¸€èˆ¬ï¼Œæœ‰å¤šä¸ªæœåŠ¡éœ€è¦åŒæ­¥



è€Œå¼‚æ­¥å®ç°åˆå¯ä»¥åŸºäºMQæˆ–è€…Canalæ¥å®ç°ï¼š

1ï¼‰åŸºäºMQçš„å¼‚æ­¥é€šçŸ¥ï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132968.png" alt="image-20210821115552327" style="zoom:50%;" />

è§£è¯»ï¼š

- å•†å“æœåŠ¡å®Œæˆå¯¹æ•°æ®çš„ä¿®æ”¹åï¼Œåªéœ€è¦å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°MQä¸­ã€‚
- ç¼“å­˜æœåŠ¡ç›‘å¬MQæ¶ˆæ¯ï¼Œç„¶åå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°

ä¾ç„¶æœ‰å°‘é‡çš„ä»£ç ä¾µå…¥ã€‚



2ï¼‰åŸºäºCanalçš„é€šçŸ¥

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132348.png" alt="image-20210821115719363" style="zoom:50%;" />

è§£è¯»ï¼š

- å•†å“æœåŠ¡å®Œæˆå•†å“ä¿®æ”¹åï¼Œä¸šåŠ¡ç›´æ¥ç»“æŸï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥
- Canalç›‘å¬MySQLå˜åŒ–ï¼Œå½“å‘ç°å˜åŒ–åï¼Œç«‹å³é€šçŸ¥ç¼“å­˜æœåŠ¡
- ç¼“å­˜æœåŠ¡æ¥æ”¶åˆ°canalé€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜

ä»£ç é›¶ä¾µå…¥

### å®‰è£…Canal

#### è®¤è¯†Canal

**Canal [kÉ™'nÃ¦l]**ï¼Œè¯‘æ„ä¸ºæ°´é“/ç®¡é“/æ²Ÿæ¸ ï¼Œcanalæ˜¯é˜¿é‡Œå·´å·´æ——ä¸‹çš„ä¸€æ¬¾å¼€æºé¡¹ç›®ï¼ŒåŸºäºJavaå¼€å‘ã€‚åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…&æ¶ˆè´¹ã€‚GitHubçš„åœ°å€ï¼šhttps://github.com/alibaba/canal

Canalæ˜¯åŸºäºmysqlçš„ä¸»ä»åŒæ­¥æ¥å®ç°çš„ï¼ŒMySQLä¸»ä»åŒæ­¥çš„åŸç†å¦‚ä¸‹ï¼š

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132353.png" alt="image-20210821115914748" style="zoom: 67%;" />

1. MySQL master å°†æ•°æ®å˜æ›´å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—( binary logï¼‰ï¼Œå…¶ä¸­è®°å½•çš„æ•°æ®å«åšbinary log events
2. MySQL slave å°† master çš„ binary log eventsæ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—(relay log)
3. MySQL slave é‡æ”¾ relay log ä¸­äº‹ä»¶ï¼Œå°†æ•°æ®å˜æ›´åæ˜ å®ƒè‡ªå·±çš„æ•°æ®



è€ŒCanalå°±æ˜¯æŠŠè‡ªå·±ä¼ªè£…æˆMySQLçš„ä¸€ä¸ªslaveèŠ‚ç‚¹ï¼Œä»è€Œç›‘å¬masterçš„binary logå˜åŒ–ã€‚å†æŠŠå¾—åˆ°çš„å˜åŒ–ä¿¡æ¯é€šçŸ¥ç»™Canalçš„å®¢æˆ·ç«¯ï¼Œè¿›è€Œå®Œæˆå¯¹å…¶å®ƒæ•°æ®åº“çš„åŒæ­¥ã€‚

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132383.png" alt="image-20210821115948395" style="zoom: 67%;" />

#### å®‰è£…Canal

**åˆ›å»ºç½‘ç»œ**

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼Œå°†MySQLã€Canalã€MQæ”¾åˆ°åŒä¸€ä¸ªDockerç½‘ç»œä¸­ï¼š

```sh
docker network create heima
```

è®© mysql åŠ å…¥è¿™ä¸ªç½‘ç»œï¼š

```sh
docker network connect heima mysql
```

**å®‰è£…**

ä» docker é•œåƒä¸­æ‹‰å– cannal

```
docker pull cannal
```



ç„¶åè¿è¡Œå‘½ä»¤åˆ›å»ºCanalå®¹å™¨ï¼š

```sh
docker run -p 11111:11111 --name canal \
-e canal.destinations=heima \
-e canal.instance.master.address=mysql:3306  \
-e canal.instance.dbUsername=canal  \
-e canal.instance.dbPassword=canal  \
-e canal.instance.connectionCharset=UTF-8 \
-e canal.instance.tsdb.enable=true \
-e canal.instance.gtidon=false  \
-e canal.instance.filter.regex=heima\\..* \
--network heima \
-d canal/canal-server:v1.1.5
```



è¯´æ˜:

- `-p 11111:11111`ï¼šè¿™æ˜¯canalçš„é»˜è®¤ç›‘å¬ç«¯å£
- `-e canal.instance.master.address=mysql:3306`ï¼šæ•°æ®åº“åœ°å€å’Œç«¯å£ï¼Œå¦‚æœä¸çŸ¥é“mysqlå®¹å™¨åœ°å€ï¼Œå¯ä»¥é€šè¿‡`docker inspect å®¹å™¨id`æ¥æŸ¥çœ‹
- `-e canal.instance.dbUsername=canal`ï¼šæ•°æ®åº“ç”¨æˆ·å
- `-e canal.instance.dbPassword=canal` ï¼šæ•°æ®åº“å¯†ç 
- `-e canal.instance.filter.regex=`ï¼šè¦ç›‘å¬çš„è¡¨åç§°

è¡¨åç§°ç›‘å¬æ”¯æŒçš„è¯­æ³•ï¼š

```
mysql æ•°æ®è§£æå…³æ³¨çš„è¡¨ï¼ŒPerlæ­£åˆ™è¡¨è¾¾å¼.
å¤šä¸ªæ­£åˆ™ä¹‹é—´ä»¥é€—å·(,)åˆ†éš”ï¼Œè½¬ä¹‰ç¬¦éœ€è¦åŒæ–œæ (\\) 
å¸¸è§ä¾‹å­ï¼š
1.  æ‰€æœ‰è¡¨ï¼š.*   or  .*\\..*
2.  canal schemaä¸‹æ‰€æœ‰è¡¨ï¼š canal\\..*
3.  canalä¸‹çš„ä»¥canalæ‰“å¤´çš„è¡¨ï¼šcanal\\.canal.*
4.  canal schemaä¸‹çš„ä¸€å¼ è¡¨ï¼šcanal.test1
5.  å¤šä¸ªè§„åˆ™ç»„åˆä½¿ç”¨ç„¶åä»¥é€—å·éš”å¼€ï¼šcanal\\..*,mysql.test1,mysql.test2 
```

### ç›‘å¬Canal

Canalæä¾›äº†å„ç§è¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œå½“Canalç›‘å¬åˆ°binlogå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥Canalçš„å®¢æˆ·ç«¯ã€‚

<img src="https://qijiayi-image.oss-cn-shenzhen.aliyuncs.com/img/202212131132399.png" alt="image-20210821120049024" style="zoom:50%;" />

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Canalæä¾›çš„Javaå®¢æˆ·ç«¯ï¼Œç›‘å¬Canalé€šçŸ¥æ¶ˆæ¯ã€‚å½“æ”¶åˆ°å˜åŒ–çš„æ¶ˆæ¯æ—¶ï¼Œå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°ã€‚

#### å¼•å…¥ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>top.javatool</groupId>
    <artifactId>canal-spring-boot-starter</artifactId>
    <version>1.2.1-RELEASE</version>
</dependency>
```

#### ç¼–å†™é…ç½®ï¼š

```yaml
canal:
  destination: heima # canalçš„é›†ç¾¤åå­—ï¼Œè¦ä¸å®‰è£…canalæ—¶è®¾ç½®çš„åç§°ä¸€è‡´
  server: 192.168.150.101:11111 # canalæœåŠ¡åœ°å€
```

#### ä¿®æ”¹Itemå®ä½“ç±»

é€šè¿‡@Idã€@Columnã€ç­‰æ³¨è§£å®ŒæˆItemä¸æ•°æ®åº“è¡¨å­—æ®µçš„æ˜ å°„ï¼š

```java
package com.heima.item.pojo;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;

import javax.persistence.Column;
import java.util.Date;

@Data
@TableName("tb_item")
public class Item {
    @TableId(type = IdType.AUTO)
    @Id
    private Long id;//å•†å“id
    @Column(name = "name")
    private String name;//å•†å“åç§°
    private String title;//å•†å“æ ‡é¢˜
    private Long price;//ä»·æ ¼ï¼ˆåˆ†ï¼‰
    private String image;//å•†å“å›¾ç‰‡
    private String category;//åˆ†ç±»åç§°
    private String brand;//å“ç‰Œåç§°
    private String spec;//è§„æ ¼
    private Integer status;//å•†å“çŠ¶æ€ 1-æ­£å¸¸ï¼Œ2-ä¸‹æ¶
    private Date createTime;//åˆ›å»ºæ—¶é—´
    private Date updateTime;//æ›´æ–°æ—¶é—´
    @TableField(exist = false)
    @Transient
    private Integer stock;
    @TableField(exist = false)
    @Transient
    private Integer sold;
}
```

#### ç¼–å†™ç›‘å¬å™¨

é€šè¿‡å®ç°`EntryHandler<T>`æ¥å£ç¼–å†™ç›‘å¬å™¨ï¼Œç›‘å¬Canalæ¶ˆæ¯ã€‚æ³¨æ„ä¸¤ç‚¹ï¼š

- å®ç°ç±»é€šè¿‡`@CanalTable("tb_item")`æŒ‡å®šç›‘å¬çš„è¡¨ä¿¡æ¯
- EntryHandlerçš„æ³›å‹æ˜¯ä¸è¡¨å¯¹åº”çš„å®ä½“ç±»



```java
package com.heima.item.canal;

import com.github.benmanes.caffeine.cache.Cache;
import com.heima.item.config.RedisHandler;
import com.heima.item.pojo.Item;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import top.javatool.canal.client.annotation.CanalTable;
import top.javatool.canal.client.handler.EntryHandler;

@CanalTable("tb_item")
@Component
public class ItemHandler implements EntryHandler<Item> {

    @Autowired
    private RedisHandler redisHandler;
    @Autowired
    private Cache<Long, Item> itemCache;

    @Override
    public void insert(Item item) {
        // å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜
        itemCache.put(item.getId(), item);
        // å†™æ•°æ®åˆ°redis
        redisHandler.saveItem(item);
    }

    @Override
    public void update(Item before, Item after) {
        // å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜
        itemCache.put(after.getId(), after);
        // å†™æ•°æ®åˆ°redis
        redisHandler.saveItem(after);
    }

    @Override
    public void delete(Item item) {
        // åˆ é™¤æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜
        itemCache.invalidate(item.getId());
        // åˆ é™¤æ•°æ®åˆ°redis
        redisHandler.deleteItemById(item.getId());
    }
}
```



åœ¨è¿™é‡Œå¯¹Redisçš„æ“ä½œéƒ½å°è£…åˆ°äº†RedisHandlerè¿™ä¸ªå¯¹è±¡ä¸­ï¼Œæ˜¯æˆ‘ä»¬ä¹‹å‰åšç¼“å­˜é¢„çƒ­æ—¶ç¼–å†™çš„ä¸€ä¸ªç±»ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```java
package com.heima.item.config;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.heima.item.pojo.Item;
import com.heima.item.pojo.ItemStock;
import com.heima.item.service.IItemService;
import com.heima.item.service.IItemStockService;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
public class RedisHandler implements InitializingBean {

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Autowired
    private IItemService itemService;
    @Autowired
    private IItemStockService stockService;

    private static final ObjectMapper MAPPER = new ObjectMapper();

    @Override
    public void afterPropertiesSet() throws Exception {
        // åˆå§‹åŒ–ç¼“å­˜
        // 1.æŸ¥è¯¢å•†å“ä¿¡æ¯
        List<Item> itemList = itemService.list();
        // 2.æ”¾å…¥ç¼“å­˜
        for (Item item : itemList) {
            // 2.1.itemåºåˆ—åŒ–ä¸ºJSON
            String json = MAPPER.writeValueAsString(item);
            // 2.2.å­˜å…¥redis
            redisTemplate.opsForValue().set("item:id:" + item.getId(), json);
        }

        // 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯
        List<ItemStock> stockList = stockService.list();
        // 4.æ”¾å…¥ç¼“å­˜
        for (ItemStock stock : stockList) {
            // 2.1.itemåºåˆ—åŒ–ä¸ºJSON
            String json = MAPPER.writeValueAsString(stock);
            // 2.2.å­˜å…¥redis
            redisTemplate.opsForValue().set("item:stock:id:" + stock.getId(), json);
        }
    }

    public void saveItem(Item item) {
        try {
            String json = MAPPER.writeValueAsString(item);
            redisTemplate.opsForValue().set("item:id:" + item.getId(), json);
        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }

    public void deleteItemById(Long id) {
        redisTemplate.delete("item:id:" + id);
    }
}
```

